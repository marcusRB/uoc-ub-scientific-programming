---
title: 'PEC4: Final assessment'
author: "Marco Russo - Silvia Gamundi Sumando"
date: "Enero, 2025"
output:
  pdf_document: 
    toc: true
    toc_depth: 4
    number_sections: true
    fig_width: 7
    fig_height: 5
    fig_caption: true
    latex_engine: xelatex
    highlight: tango
    citation_package: natbib
header-includes:
- \usepackage{xcolor}
- \usepackage{framed}
- \usepackage{listings}
- \usepackage{fancyhdr}
- \usepackage{geometry}
- \usepackage{caption}
- \usepackage{booktabs}
- \usepackage{longtable}
- \usepackage{array}
- \usepackage{multirow}
- \usepackage{wrapfig}
- \usepackage{float}
- \usepackage{colortbl}
- \usepackage{pdflscape}
- \usepackage{tabu}
- \usepackage{threeparttable}
- \usepackage{graphicx}
- \geometry{top=2.5cm, bottom=2.5cm, left=2.5cm, right=2.5cm}
- \pagestyle{fancy}
- \fancyfoot[C]{\thepage}
- \renewcommand{\headrulewidth}{0.4pt}
- \renewcommand{\footrulewidth}{0.4pt}
editor_options: 
  markdown: 
    wrap: 72
bibliografy: 7554815.bib
---

\newpage

Información del Estudiante

\begin{center}
\begin{tabular}{|l|l|}
\hline
\textbf{Nombre} & Marco Russo \\
\hline
\textbf{Email} & mrussorb@uoc.edu \\
\hline
\textbf{GitHub} & https://github.com/marcusRB/uoc-ub-scientific-programming \\
\hline
\textbf{LinkedIn} & https://www.linkedin.com/in/marcusrb/ \\
\hline
\textbf{Fecha} & \today \\
\hline
\end{tabular}
\end{center}
\begin{center}
\begin{tabular}{|l|l|}
\hline
\textbf{Nombre} & Silvia Gamundi Sumando \\
\hline
\textbf{Email} & sgamundis@uoc.edu
 \\
\hline
\textbf{GitHub} & https://github.com/ \\
\hline
\textbf{LinkedIn} & https://www.linkedin.com/in/ \\
\hline
\textbf{Fecha} & \today \\
\hline
\end{tabular}
\end{center}

\newpage

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, 
                      fig.width = 8, fig.height = 5 )
```

# 1. Contexto y objetivo del estudio. Datos (1 punto)

El dataset elegido es `Bacteremia` del autor Heinze, G. (2023). Bacteremia [Data
set]. In PLoS One (Version S2, Vol. 9, Number 9, p. e106765). Zenodo.
<https://doi.org/10.5281/zenodo.7554815> [@dataset]

El resto de informaciones ha sido extracto de la fuenta oficial:

> The data set consists of 14,691 observations from different patients
> with the clinical suspicion to suffer from bacteremia, for whom a a
> blood culture analysis was performed at the Vienna General Hospital,
> Austria, between January 2006 and December 2010. It contains the
> results of the blood culture analysis for bacteremia and the values of
> 51 potential predictors of bacteremia. To protect data privacy our
> version of this data was slightly modified compared to the original
> version, and this modified version was cleared by the Medical
> University of Vienna for public use (DC 2019-0054). Details on the
> meaning of the variables can be found in the data dictionary. The
> original version of the data set was used by Ratzinger et al (2014) to
> develop a model for screening bacteremic patients based on highly
> standardizable laboratory variables. This public version has been used
> by Gregorich et al (2021).

Basada en la descripción oficial del mismo, se indican que existen
14,691 observaciones de diferentes pacientes que podrían ser afectos de
`bacteriemia`. De la información disponible en
[Wikipedia:Bacteriemia](https://es.wikipedia.org/wiki/Bacteriemia), la
bacteriemia es la presencia de bacterias en la sangre. La sangre es
normalmente un medio estéril, por lo tanto la detección de bacterias es
indicativa de infección.

Es importante entender este punto respecto al **diagnóstico**, muchas
personas se recuperan completamente de la bacteriemia. Sin embargo, la
bacteriemia es grave y puede provocar sepsis. Cuando tiene sepsis, el
daño a los órganos principales puede ser irreversible.

Entre las **causas**, la entrada de bacterias en el torrente sanguíneo
puede ser producto de una infección localizada (ej: neumonía, absceso en
piel o mucosas), o por interrupción de la piel como barrera defensiva.
Se destacan las intervenciones quirúrgicas, utilización de dispositivos
invasivos (catéteres, sondas, asistencia mecánica respiratoria), heridas
accidentales, o quemaduras.

La infección suele empezar en los pulmones, el tracto genitourinario,
gastrointestinal o los tejidos blandos, entre ellos la piel de pacientes
con úlceras. También puede ser secundaria a una intervención dental en
pacientes de alto riesgo, especialmente en los que tienen prótesis
intravasculares.

Respecto a las **consecuencias**, dependen del tipo de bacteria y el
estado del paciente. La respuesta inmunológica a la infección puede
causar sepsis y devenir en shock séptico. También puede ocurrir que la
sangre transporte las bacterias a otros tejidos, que podrán ser
infectados. Ejemplos incluyen endocarditis, osteomielitis, y meningitis.
El tratamiento es fundamental para erradicar a las bacterias y requiere
el uso de antibióticos por vía intravenosa.

Se dispone de un pequeño diccionario que incluye el significado de cada
característica del dataset. Lo descargaremos y visualizaremos para
entender mejor el contexto de cada característica del dataset.

------------------------------------------------------------------------

# 2. Prospección y preparación de los datos (2 puntos)

## 2.1 Descripción de los datos (1 punto)

Preparamos el entorno cargando el resto de librerías que serán útiles
para realizar un análisis exploratorio de los datos.

```{r include=FALSE}
# Observamos las librerías disponibles y descargaremos el resto
if(!require('corrplot')) install.packages('corrplot'); library('corrplot')
if(!require('tidyverse')) install.packages('tidyverse'); library('tidyverse')
if(!require('ggplot2')) install.packages('ggplot2'); library('ggplot2')
if(!require('dplyr')) install.packages('dplyr'); library('dplyr')
if(!require('naniar')) install.packages('naniar'); library('naniar')
```

Descargamos el dataset en un formato dataframe y comprobaremos su
estructura.

```{r}
# Define the URL and file path
url <- "https://zenodo.org/records/7554815/files/Bacteremia_public_S2.csv?download=1"
filename <- "data/bacteremia_dataset.csv"

# Create directory if it doesn't exist
if (!dir.exists("data")) {
  dir.create("data", recursive = TRUE)
  
  # Download the file
  download.file(url, destfile = filename, mode = "wb")
} else {
  sprintf("The dataset has been downloaded and is available in 'data' path")
}

```

```{r}
# Read the CSV file
bacteremia_df <- read.csv(file = filename)

# Preview the data
dplyr::glimpse(bacteremia_df)
```

Finalmente mostramos los primeros datos y la naturaleza de las
características.

```{r}
# Mostramos los primeros datos con head()
head(bacteremia_df, 10)
```

```{r}
# Mostramos los últimos datos también con tail()
tail(bacteremia_df, 10)
```

Realizaremos un exploratorio genérico del dataset. Mostrando información
básica del dataset, para pasar luego a los estadísticos básico y
comenzaremos a interactuar con las características luego.

Verificamos la estructura del juego de datos principal. Vemos el número
de columnas que tenemos y ejemplos de los contenidos de las filas.

```{r}
str(bacteremia_df)
```

```{r}
# Observamos su composición
dim(bacteremia_df)
```

Vemos que tenemos **53** características y **14691** observaciones.
Deberíamos profundizar ahora respecto al tipo de dato de cada variable y
realizar un exploratorio básico para ver inconsistencias.

```{r}
# Obtenemos el datatype de cada característica
sapply(bacteremia_df, class)
```

Respecto a las características, no tenemos transformaciones previas a realizar,
exceptuando nuevas features que podríamos crear sucesivamente.

Procederemos con un exploratorio básico extrayendo la información estadístico
de las características del dataset.

```{r}
# Install and load necessary packages
# install.packages(c("summarytools", "skimr", "DataExplorer"))
library(summarytools)
library(skimr)
library(DataExplorer)

# Try a simpler version first
dfSummary(bacteremia_df)
```

De las 53 características observamos que existen:

- 2 variables del tipo numérica discretas (SEX, BloodCulture), aunque podríamos
tratar esta última como variable dependiente.
- 50 variables son del tipo numérica continua a excpeción de la característica 
id del paciente `ID`, que no es considerada para la modelización, peró en caso
de realizar segmentación, podría ser útil.

Hay que tener en cuenta que la variable `AGE` ha sido modificada ligermente por
lo que los estudios analíticos a continuación, no serán del todo precisas y 
fiables. Por lo que propondríamos suposiciones a lo largo del estudio.

Podemos revisar la descripción de las variables contenidas en el fichero
y si los tipos de variables se corresponden con las que hemos cargado.
Las organizamos lógicamente para darles sentido y construimos un pequeño
diccionario de datos utilizando la documentación auxiliar.

Respecto al significado de cada una de las features utilizaremos el
fichero DataDictionary -
<https://zenodo.org/records/7554815/files/bacteremia-DataDictionary.csv>
disponible en la misma página oficial para interpretar los valores.

```{r }
# Read directly from URL
dictionary_df <- read.csv("https://zenodo.org/records/7554815/files/bacteremia-DataDictionary.csv?download=1")

# Display as a nice formatted table
library(DT)
datatable(dictionary_df,
          options = list(pageLength = 20,
                         scrollX = TRUE,
                         searchHighlight = TRUE),
          rownames = FALSE)
```

A continuación comprobaremos los valores nulos que podrían estar en nuestro dataset.


```{r}
# Verificación de valores perdidos
na_count <- sapply(bacteremia_df, function(x) sum(is.na(x)))
print(na_count[na_count > 0])
```

De las 14691 observaciones, disponemos de muchos valores nulos, podemos realizar un análisis para comprobar el porcentaje que podría este afectar a la estabilidad de los análisis.

```{r}

# Visualize missing values by variable
gg_miss_var(bacteremia_df, show_pct = TRUE) +
  labs(title = "variables faltantes en Bacteremia",
       x = "Variables",
       y = "Ratio de los valores nulos")
```

Calcularemos los valores totales y su ratio.


```{r}
missing_summary <- data.frame(
  Variable = names(bacteremia_df),
  Missing_Count = colSums(is.na(bacteremia_df)),
  Missing_Percent = round(colSums(is.na(bacteremia_df))/nrow(bacteremia_df)*100, 2)
) %>%
  arrange(desc(Missing_Percent))

print("Missing Data Summary:")
print(missing_summary)
```

Notamos que no existe características que superen al umbral del 70% de los valores nulos, lo que podríamos
considerar a eliminar la característica de nuestros análisis.

Sin embargo, hay valores que necesitaríamos analizar a posteriori por tener unos valores 
faltantes entre el 10% y 40% que supone tener que tomar decisiones.

```{r}
filter(missing_summary, missing_summary$Missing_Percent > 20)
```


```{r}
filter(missing_summary, missing_summary$Missing_Percent > 0 & missing_summary$Missing_Percent < 20)
```

Tenemos 7 características superior al 20% de valores nulos y 42 de muy residual, debajo del 1% hasta el 20%. Podemos realizar un análisis exhaustivo para poder tomar decisiones al respecto, cuáles tareas de imputaciones de los valores faltantes por segmentación de valores cercanos (por ejemplo algún valor estadístico tipo media, mediana) o a través de técnicas de aprendizaje automático (utilizar segmentación a través de k-Means u otros métodos supervisado tipo kNN).

***

## 2.2 Preguntas “objetivo” (1 punto)

Antes de comenzar con las preguntas objetivos, obtenemos una clasificación de los valores indicadores para el hemocultivo. De esta manera agruparemos los valores de las features por categoría:

* A. Marcadores de inflamación e infección
Estos aumentan en casos de infecciones, sepsis y bacteriemia.

| Variable | Meaning                    |
| -------- | -------------------------- |
| CRP      | C-reactive protein         |
| HS       | Hypersensitive CRP         |
| NT       | Neutrophils                |
| WBC      | White blood cells          |
| LDH      | Cell damage / inflammation |

Estas variables deben tener una correlación fuerte con nuestra variable target.

* B. Coagulación y hemostasia
La infección puede provocar una disfunción de la coagulación.

| Variable | Meaning          |
| -------- | ---------------- |
| FIB      | Fibrinogen       |
| APTT     | Coagulation time |
| PLT      | Platelets        |

Debería tener una correlación indirecta. Está relacionada con sepsis.

* C. Perfil metabólico y lipídico
A menudo se altera durante enfermedades sistémicas.

| Variable | Meaning       |
| -------- | ------------- |
| GLU      | Glucose       |
| TRIG     | Triglycerides |
| CHOL     | Cholesterol   |

Deberían tener una relación indirecta, está correlacionada con el estrés metabólico.

* D. Función hepática y proteínas
El hígado reacciona a la inflamación y a las infecciones.

| Variable | Meaning        |
| -------- | -------------- |
| ALB      | Albumin        |
| TP       | Total proteins |
| CHE      | Cholinesterase |

Hay una relación indirecta con la variable target

* E. Daño tisular/muscular
Lesión celular o estrés sistémico.

| Variable | Meaning         |
| -------- | --------------- |
| CK       | Creatine kinase |
| LDH      | Cell damage     |


* F. Enzimas pancreáticas (contextual)
Se miden solo ante sospecha de pancreatitis.

| Variable | Meaning            |
| -------- | ------------------ |
| AMY      | Amylase            |
| PAMY     | Pancreatic amylase |
| LIP      | Lipase             |

Deberían tener una relación débil, también justifica muchos valores nulos.


* G. Electrolitos y minerales
Se alteran en casos de enfermedad grave.

| Variable | Meaning   |
| -------- | --------- |
| POTASS   | Potassium |
| MG       | Magnesium |

Desde esta referencia, se recogen muchos del significado de los valores, y de los rangos de interés para poder contestar a unas preguntas que realizamos a continuación.

**IMPORTANTE** Los rangos de referencia típicos que mostramos a continuación son para interpretar los datos no para diagnóstico.

| Variable | Typical Range  |
| -------- | -------------- |
| CRP      | < 5 mg/L       |
| HS       | < 1 mg/L       |
| WBC      | 4–10 ×10⁹/L    |
| NT       | 40–75 %        |
| GLU      | 70–100 mg/dL   |
| CHOL     | < 200 mg/dL    |
| TRIG     | < 150 mg/dL    |
| ALB      | 3.5–5.0 g/dL   |
| LDH      | 140–280 U/L    |
| CK       | 30–200 U/L     |
| FIB      | 200–400 mg/dL  |
| APTT     | 25–35 s        |
| POTASS   | 3.5–5.1 mmol/L |
| AMY      | 30–110 U/L     |
| LIP      | < 160 U/L      |




### ¿Existen diferencias descriptivas en los marcadores inflamatorios entre pacientes con y sin bacteriemia?

Podemos contestar a esta pregunta comparando la tendencia y dispersión de variables según el estado del hemocultivo. 


### ¿Cómo es la distribución de las variables metabólicas y qué asimetría presentan?

Podemos describir la forma de distribución de cada feature y detectar asimetría y valores extremos (outliers).

### ¿Cuál es la relación descriptiva entre variables fisiológicas y existen agrupaciones naturales?

Aquí podemos explorar asociaciones entre variables y detectar patrones comunes.


### ¿Existen diferencias descriptivas en la proporción de bacteriemia según categorías clínicas simples?

Podemos describir frecuencias y proporciones.


***

# 3. Análisis exploratorio de los datos (2,5 puntos)

## 3.1 Análisis descriptivo y gráfico (1 punto)

El primer dato que tenemos es la proporción que hay entre las dos
clases:

```{r}
class_ratio <- prop.table(table(bacteremia_df$BloodCulture))
sprintf("La proporción de la variable dependiente es: %.2f 
        para los valores %s %.2f y para los valores %s.", class_ratio[1]*100, names(class_ratio)[1], class_ratio[2]*100,
        names(class_ratio)[2])

```

Vemos que la diferencia del ratio de la posible variable dependiente está bastante desbalanceada a favor de los casos de valores negativos que positivos, 92-8.


## 3.2 Limpieza de los datos

### El algoritmo MICE

La imputación múltiple mediante ecuaciones encadenadas es un método robusto e informativo para gestionar la falta de datos en conjuntos de datos. Este procedimiento rellena (imputa) los datos faltantes en un conjunto de datos mediante una serie iterativa de modelos predictivos. En cada iteración, cada variable especificada en el conjunto de datos se imputa utilizando las demás variables. Estas iteraciones deben ejecutarse hasta que se observe que se ha alcanzado la convergencia.

**Fuga de datos**:

MICE es especialmente útil si los valores faltantes están asociados con la variable objetivo de una forma que introduce fugas. Por ejemplo, supongamos que se desea modelar la retención de clientes en el momento del registro. Una variable se recopila en el momento del registro o un mes después. La ausencia de esa variable constituye una fuga de datos, ya que indica que el cliente no se retuvo durante un mes.

**Análisis del embudo**:

La información suele recopilarse en diferentes etapas de un embudo. MICE puede utilizarse para realizar estimaciones fundamentadas sobre las características de las entidades en diferentes puntos de un embudo.

**Intervalos de confianza**:

MICE puede utilizarse para imputar valores faltantes; sin embargo, es importante tener en cuenta que estos valores imputados constituyen una predicción. Crear múltiples conjuntos de datos con diferentes valores imputados permite realizar dos tipos de inferencia:

* Distribución de valores imputados: Se puede crear un perfil para cada valor imputado, lo que permite realizar afirmaciones sobre la distribución probable de dicho valor.

* Distribución de predicción del modelo: Con múltiples conjuntos de datos, se pueden crear múltiples modelos y una distribución de predicciones para cada muestra. Las muestras con valores imputados que no pudieron imputarse con mucha confianza presentarían una mayor varianza en sus predicciones.


Hacemos una copia del dataset y probamos solamente dos métodos.

```{r}
bak_bacteremia_df <- bacteremia_df
```

El primer método es performar con MICE, tal como explicado, sin embargo este método podría tardar muchas horas en ejecutarse.

```{r}
# Multiple imputation using MICE
# cat("\nPerforming Multiple Imputation...\n")
# imputed_data <- mice(bacteremia_df, 
#                      m = 5, 
#                      maxit = 50, 
#                      method = 'pmm', 
#                      seed = 42)
# 
# # Extract first imputed dataset
# bacteremia_mice_imputed <- complete(imputed_data, 1)
# 
# # Check imputation quality
# cat("\nMissing values after imputation:", sum(is.na(bacteremia_mice_imputed)), "\n")
```


Understanding Scatterplots and Bivariate Analysis



```{r}

```




------------------------------------------------------------------------

## 3.2. Ejercicios de inferencia y simulación (1,5 puntos)

ver LAB3, LAB4, PEC2

------------------------------------------------------------------------

# 4. Modelos de aprendizaje automático (2,5 puntos)

ver LAB5 y PEC3

------------------------------------------------------------------------

# 5. Visualización (1,5 puntos)

Aplicación Shiny con alguna solución aportada / análisis

ver LAB6 y PEC3

------------------------------------------------------------------------

# 6. Conclusiones (0,5 puntos)

Valoraciones finales...

* ¿Disponemos de conclusiones finales?
* ¿Sería necesario realizar un análisis más avanzado?
* ¿Faltan datos para obtener otro tipo de información como…?
* ¿Se puede utilizar alguna de las conclusiones para tomar algún tipo de decisiones?


***

# Bibliografía

References

1.  Wolberg,W.H., and Mangasarian,O.L. (1990). Multisurface method of
    pattern separation for medical diagnosis applied to breast cytology.
    In Proceedings of the National Academy of Sciences, 87, 9193-9196.

-   Size of data set: only 369 instances (at that point in time)
-   Collected classification results: 1 trial only
-   Two pairs of parallel hyperplanes were found to be consistent with
    50% of the data
-   Accuracy on remaining 50% of dataset: 93.5%
-   Three pairs of parallel hyperplanes were found to be consistent with
    67% of data
-   Accuracy on remaining 33% of dataset: 95.9%

2.  Zhang,J. (1992). Selecting typical instances in instance-based
    learning. In Proceedings of the Ninth International Machine Learning
    Conference (pp. 470-479). Aberdeen, Scotland: Morgan Kaufmann.

-   Size of data set: only 369 instances (at that point in time)
-   Applied 4 instance-based learning algorithms
-   Collected classification results averaged over 10 trials
-   Best accuracy result:
-   1-nearest neighbor: 93.7%
-   trained on 200 instances, tested on the other 169
-   Also of interest:
-   Using only typical instances: 92.2% (storing only 23.1 instances)
-   trained on 200 instances, tested on the other 169

Blake, C.L. & Merz, C.J. (1998). UCI Repository of Machine Learning
Databases. Irvine, CA: University of California, Irvine, Department of
Information and Computer Science. Formerly available from
<http://www.ics.uci.edu/~mlearn/MLRepository.html>.

-   <https://shiny.posit.co/py/templates/>

------------------------------------------------------------------------

